"use strict";var resolve={loadProfile:["$route","$interval","ProfileManager","Session","FileUtils",function(a,b,c,d,e){if(null!==d.autosave_interval&&(b.cancel(d.autosave_interval),d.autosave_interval=null),d.form&&d.form.status){var f=window.confirm("Do you want to save the file before moving?");f&&e.save()}return d.form=null,c.load(a.current.params.user)}]};angular.module("waxeApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.layout","ui.bootstrap","ui.codemirror","diff-match-patch"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:resolve}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/account/:user",{templateUrl:"views/filemanager.html",controller:"FileManagerCtrl",resolve:resolve}).when("/account/:user/search",{templateUrl:"views/search.html",controller:"SearchCtrl",resolve:resolve}).when("/account/:user/versioning",{templateUrl:"views/versioning.html",controller:"VersioningCtrl",resolve:resolve}).when("/account/:user/versioning/update",{templateUrl:"views/versioningupdate.html",controller:"VersioningUpdateCtrl",resolve:resolve}).when("/account/:user/versioning/diff",{templateUrl:"views/versioningdiff.html",controller:"VersioningDiffCtrl",resolve:resolve}).when("/account/:user/versioning/unified-diff",{templateUrl:"views/versioningunifieddiff.html",controller:"VersioningUnifiedDiffCtrl",resolve:resolve,diff:!0}).when("/account/:user/txt/edit",{templateUrl:"views/edittxt.html",controller:"EditTxtCtrl",resolve:resolve,editor:!0,type:"txt",action:"edit"}).when("/account/:user/:type/edit",{templateUrl:"views/edit.html",controller:"EditCtrl",resolve:resolve,editor:!0,type:"xml",action:"edit"}).when("/account/:user/:type/new",{templateUrl:"views/edit.html",controller:"EditCtrl",resolve:resolve,noAutoBreadcrumb:!0,type:"xml",action:"new"}).otherwise({redirectTo:"/"}),b.interceptors.push("HttpInterceptor")}]).run(["$rootScope","Session","MessageService",function(a,b,c){a.$on("$routeChangeStart",function(a,b,d){angular.isDefined(d)&&(angular.isDefined(d.$$route.editor)&&d.$$route.editor===b.$$route.editor||c.close()),c.setIfEmpty("loading","Loading...","info")}),a.$on("$routeChangeError",function(){c.close("loading")}),a.$on("pageLoaded",function(a){a.targetScope.pageLoaded=!0,c.setIfEmptyOrSameType("loading","Loaded","info",1e3)}),window.onbeforeunload=function(a){if(b.form&&b.form.status){a=a||window.event;var c="The file has been updated, are you sure you want to exit?";return a&&(a.returnValue=c),c}}}]),angular.module("waxeApp").controller("MainCtrl",["$scope","$location","UrlFactory","UserProfile","Session",function(a,b,c,d,e){var f=b.search().path;if(d.has_file===!0){var g;return g=angular.isDefined(f)?c.userUrl("xml/edit",{path:f}):c.userUrl(),void b.url(g)}a.$emit("pageLoaded"),a.Session=e,a.UrlFactory=c,a.UserProfile=d,a.path=f}]),angular.module("waxeApp").controller("LoginCtrl",["$scope","$location","AuthService","UserProfile",function(a,b,c,d){a.$emit("pageLoaded"),a.UserProfile=d,a.credentials={login:"",password:""},a.login=function(a){c.login(a).then(function(){c.profile().then(function(){var a=b.search().next;"undefined"!=typeof a?b.url(a):b.url("/")})})}}]),angular.module("waxeApp").service("AuthService",["$http","$q","UserProfile","AccountProfile","UrlFactory","Session",function(a,b,c,d,e,f){return this.login=function(b){return a.post(e.jsonAPIUrl(null,"login"),b).then(function(a){c.create(a.data),f.init()})},this.logout=function(){return a.get(e.jsonAPIUrl(null,"logout")).then(function(){c.destroy(),d.destroy(),f.init()})},this.profile=function(){return a.get(e.jsonAPIUrl(null,"profile")).then(function(a){c.create(a.data)})},this}]),angular.module("waxeApp").service("ProfileManager",["$q","$http","UserProfile","AccountProfile","UrlFactory","Session",function(a,b,c,d,e,f){this.load=function(g){var h=angular.isDefined(c.login),i=!1;if(angular.isDefined(g)&&d.login!==g&&(i=!0),!i&&h)return angular.isDefined(g)?f.init(d.login,!0):f.init(c.login,!1),a.when(!0);if(i){var j={};return h||(j={full:!0}),b.get(e.jsonAPIUrl(g,"account-profile"),{params:j}).then(function(a){h||c.create(a.data.user_profile),d.create(a.data.account_profile),f.load()})}return b.get(e.jsonAPIUrl(null,"profile")).then(function(a){c.create(a.data),f.load()})}}]).service("UserProfile",function(){var a=[];this.create=function(b){for(var c in b)a.push(c),this[c]=b[c]},this.destroy=function(){for(var b=0,c=a.length;c>b;b++)delete this[a[b]]}}).service("AccountProfile",function(){var a=[];this.create=function(b){for(var c in b)a.push(c),this[c]=b[c]},this.destroy=function(){for(var b=0,c=a.length;c>b;b++)delete this[a[b]]}}),angular.module("waxeApp").factory("UrlFactory",["Session",function(a){var b="/api/1";return"undefined"!=typeof API_BASE_PATH&&(b=API_BASE_PATH),{_generateUrl:function(a,b,c){var d="";if(a&&(d="/account/"+a),angular.isDefined(b)&&(d+="/"+b),angular.isDefined(c)){var e=[];angular.forEach(c,function(a,b){e.push(b+"="+a)}),d+="?"+e.join("&")}return d},_generateUserUrl:function(){var b=[];return b.push(a.login),b.push.apply(b,arguments),this._generateUrl.apply(this,b)},url:function(){return this._generateUrl.apply(this,arguments)},userUrl:function(){return this._generateUserUrl.apply(this,arguments)},_generateAPIUrl:function(a){var c=b;return 0!==a.indexOf("/")&&(c+="/"),c+a},_generateJsonAPIUrl:function(a){return a+=".json",this._generateAPIUrl(a)},APIUrl:function(){var a=this._generateUrl.apply(this,arguments);return this._generateAPIUrl(a)},APIUserUrl:function(){var a=this._generateUserUrl.apply(this,arguments);return this._generateAPIUrl(a)},jsonAPIUrl:function(){var a=this._generateUrl.apply(this,arguments);return this._generateJsonAPIUrl(a)},jsonAPIUserUrl:function(){var a=this._generateUserUrl.apply(this,arguments);return this._generateJsonAPIUrl(a)}}}]),angular.module("waxeApp").directive("message",["MessageService",function(a){return{template:'<div class="alert-message alert alert-{{MessageService.classname}}" ng-class="MessageService.animation" ng-if="MessageService.message">{{MessageService.message}}<button type="button" class="close" ng-click="MessageService.close()">x</button></div>',restrict:"E",link:function(b,c){b.MessageService=a,b.$watch(function(){if(b.MessageService.message){var a=c.children().eq(0),d=($("body").width()-a.outerWidth())/2;a.css({left:d+"px"})}})}}}]),angular.module("waxeApp").service("MessageService",["$timeout",function(a){this.message=null,this.type=null,this.timer=null,this.set=function(b,c,d,e){this.timer&&a.cancel(this.timer),this.type=b,this.message=c,this.classname=angular.isDefined(d)?d:this.type;var f=angular.isDefined(e)?e:3e3;if("success"===this.type||angular.isDefined(e)){var g=this;this.timer=a(function(){g.close()},f)}},this.setIfEmpty=function(a,b,c,d){return this.message?!1:void this.set(a,b,c,d)},this.setIfEmptyOrSameType=function(a,b,c,d){return this.message&&a!==this.type?!1:void this.set(a,b,c,d)},this.close=function(a){return angular.isDefined(a)&&a!==this.type?!1:void(this.message=null)}}]),angular.module("waxeApp").directive("navbar",["$location","$modal","$http","NavbarService","UserProfile","AccountProfile","AuthService","MessageService","XmlUtils","Utils","FileUtils","UrlFactory","Session","$routeParams","$route",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return{templateUrl:"views/navbar.html",restrict:"E",transclude:!0,replace:!0,link:function(p){p.NavbarService=d,p.UserProfile=e,p.AccountProfile=f,p.UrlFactory=l,p.Session=m,p.FileUtils=k,p.logout=function(){g.logout().then(function(){a.path("/login")},function(a){h.set("danger",a.data)})},p.search={text:""},p.doSearch=function(){a.url(l.userUrl("search")).search({search:p.search.text}),p.search.text=""},p.doRender=function(){var a=l.jsonAPIUserUrl("xml/view")+"?path="+n.path;window.open(a,"_viewer")},p.dtd_url=null,p.dtd_tag=null,p.newXmlModal=function(){var c=b.open({templateUrl:"navbar-new.html",controller:["$scope","$modalInstance","parentScope",function(a,b,c){a.dtd_url=c.dtd_url||f.dtd_urls[0],a.updateDtdTags=function(b){a.dtdTags=[],i.getDtdTags(a.dtd_url).then(function(c){a.dtdTags=c,a.dtd_tag=b||a.dtdTags[0]})},a.updateDtdTags(c.dtd_tag),a.ok=function(){b.close({dtd_url:a.dtd_url,dtd_tag:a.dtd_tag}),c.dtd_url=a.dtd_url,c.dtd_tag=a.dtd_tag},a.cancel=function(){b.dismiss("cancel")}}],resolve:{parentScope:function(){return p}}});c.result.then(function(b){var c=l.userUrl("xml/new");a.path(c).search(b)})},p.currentXmlTemplatePath=null,p.newXmlTemplateModal=function(){b.open({templateUrl:"navbar-open.html",controller:["$scope","$modalInstance","parentScope",function(a,b,d){a.url="xml/new",a.open=function(b){d.currentXmlTemplatePath=b,a.breadcrumbFiles=j.getBreadcrumbFiles(b,f.templates_path);var e=l.jsonAPIUserUrl("explore");c.get(e,{params:{path:b}}).then(function(b){a.files=b.data})},a.open(d.currentXmlTemplatePath||f.templates_path),a.cancel=function(){b.dismiss("cancel")}}],resolve:{parentScope:function(){return p}}})},m.currentPath=null,p.openModal=function(){b.open({templateUrl:"navbar-open.html",controller:["$scope","$modalInstance",function(a,b){a.url="xml/edit",a.open=function(b){m.currentPath=b,a.breadcrumbFiles=j.getBreadcrumbFiles(b);var d=l.jsonAPIUserUrl("explore");c.get(d,{params:{path:b}}).then(function(b){a.files=b.data})},a.open(m.currentPath),a.cancel=function(){b.dismiss("cancel")}}]})},p.sourceToggle=function(){var b=n.from,c=o.current.$$route.type;if("undefined"==typeof b||"source"!==n.fromtype){if("txt"!==c){var d=l.userUrl("txt/edit"),e={path:n.path,from:b||a.path(),fromtype:"source"};a.path(d).search(e)}}else a.path(b).search({path:n.path})},p.diffToggle=function(){var b=n.from;if("undefined"==typeof b||"diff"!==n.fromtype){var c=l.userUrl("versioning/unified-diff"),d={path:n.path,from:b||a.path(),fromtype:"diff"};a.path(c).search(d)}else a.path(b).search({path:n.path})},p.showDiff=function(){var b=l.userUrl("versioning/unified-diff"),c={path:n.path};a.path(b).search(c)}}}}]),angular.module("waxeApp").service("NavbarService",function(){}),angular.module("waxeApp").factory("HttpInterceptor",["$location","$q","MessageService",function(a,b,c){return{responseError:function(d){return 401===d.status&&"/login"!==a.$$path?(a.url("/login?next="+encodeURIComponent(a.url())),b.reject(d)):(c.set("danger",d.data),b.reject(d))}}}]),angular.module("waxeApp").controller("FileManagerCtrl",["$scope","$http","$routeParams","UrlFactory","AccountProfile","UserProfile","Session",function(a,b,c,d,e,f,g){var h=d.jsonAPIUserUrl("explore");b.get(h,{params:c}).then(function(b){a.files=b.data,a.$emit("pageLoaded")}),a.UrlFactory=d,a.UserProfile=f,g.showFileFilter=!0,a.versioning={},e.has_versioning&&(h=d.jsonAPIUserUrl("versioning/short-status"),b.get(h,{params:c}).then(function(b){a.versioning=b.data})),a.opened_files=[],a.commited_files=[],h=d.jsonAPIUrl(null,"last-files"),b.get(h).then(function(b){a.opened_files=b.data.opened_files,a.commited_files=b.data.commited_files})}]),angular.module("waxeApp").controller("EditCtrl",["$scope","$http","$sce","$routeParams","$route","$location","$compile","UrlFactory","Session",function(a,b,c,d,e,f,g,h,i){var j=e.current.$$route.action,k=h.jsonAPIUserUrl(d.type+"/"+j);b.get(k,{params:d}).then(function(b){a.html=b.data.content,a.treeData=b.data.jstree_data,i.hasForm=!0,a.$emit("pageLoaded")},function(){var a=h.userUrl("txt/"+j),b=f.path();f.path(a).search({path:d.path,from:b,fromtype:"source"})}),a.external_current=-1,a.external_values=[],a.closeExternalEditor=function(){a.showExternalEditor=!1};var l,m,n=angular.element(".external-editor");n.bind("dragstart",function(a){l=a.originalEvent.clientX,m=a.originalEvent.clientY}),n.bind("dragend",function(a){var b=a.originalEvent.clientX,c=a.originalEvent.clientY,d=n.position(),e=d.left,f=d.top,g=e-(l-b),h=f-(m-c);n.css({left:g,top:h,right:"auto",bottom:"auto"})}),a.externalResetSizeAndPosition=function(){n.removeAttr("style").find(".modal-content").removeAttr("style")},a.externalEditor=function(b){a.showExternalEditor=!0;var c=angular.element(xmltool.utils.escapeAttr("#"+b)).find("textarea:first");a.externalIsContenteditable=!1,c.is(":visible")?a.external_values.push(c.val()):(c=c.next(),a.externalIsContenteditable=!0,a.external_values.push(c.html())),a.external_current++,c.attr("ng-model","external_values["+a.external_current+"]"),g(c)(a)}}]),angular.module("waxeApp").directive("editor",["$interval","Session","FileUtils",function($interval,Session,FileUtils){return{template:"<div></div>",restrict:"E",scope:{html:"="},link:function postLink(scope,element){element.append(scope.html);var listener=scope.$watch(function(){element.text()&&(listener(),waxe.form=new waxe.Form(scope.$parent.treeData),Session.form=waxe.form,angular.element(document).on("click",".btn-external-editor",function(){eval("scope.$parent."+angular.element(this).attr("ng-click"))}))});Session.autosave_interval=$interval(function(){Session.form&&Session.form.filename&&"updated"===Session.form.status&&FileUtils.save()},3e3)}}}]),angular.module("waxeApp").service("Session",["$http","$q","$route","Utils","UserProfile","AccountProfile",function(a,b,c,d,e,f){this.currentPath=null,this.autosave_interval=null,this.init=function(a,b){if(this.login=a,this.accountUsable=b,this.currentFile=null,this.user=null,this.breadcrumbFiles=[],this.showFileFilter=!1,this.submitForm=null,this.hasForm=null,this.form=null,this.from=c.current.params.from,this.editor="undefined"!=typeof c.current.$$route.editor,this.diff="undefined"!=typeof c.current.$$route.diff,this.showSource=this.editor||this.diff,this.sourceEnabled=!1,this.editor&&"undefined"!=typeof this.from&&(this.sourceEnabled=!0),this.showDiff=f.has_versioning&&(this.diff||this.editor),this.diffEnabled=!1,this.diff&&"undefined"!=typeof this.from&&(this.diffEnabled=!0),this.accountUsable){var d="(new file)";"undefined"==typeof c.current.$$route.noAutoBreadcrumb&&(d=c.current.params.path),this.setBreadcrumbFiles(d)}},this.load=function(){angular.isDefined(f.login)?this.init(f.login,!0):this.init(e.login,!1)},this.setBreadcrumbFiles=function(a){a&&this.currentFile===a||(this.currentFile=a,this.breadcrumbFiles=d.getBreadcrumbFiles(this.currentFile))}}]),angular.module("waxeApp").directive("breadcrumb",["Session","$routeParams","UrlFactory",function(a,b,c){return{template:'<div class="breadcrumb navbar-fixed-top" ng-if="session.breadcrumbFiles.length"><li ng-repeat="file in session.breadcrumbFiles"><a ng-if="isDefined(file.path)" href="#{{UrlFactory.userUrl(\'\', {path: file.path})}}">{{file.name}}</a><span ng-if="!isDefined(file.path)">{{file.name}}</span></li><li ng-if="Session.showFileFilter"><input type="text" ng-model="session.fileFilter" class="form-control" /></div>',restrict:"E",replace:!0,link:function(b){b.session=a,b.UrlFactory=c,b.isDefined=angular.isDefined}}}]),angular.module("waxeApp").service("XmlUtils",["$http","$q","UrlFactory",function(a,b,c){this._dtdTags={},this.getDtdTags=function(d,e){if(e="undefined"==typeof e?!1:e,e in this._dtdTags||(this._dtdTags[e]={}),d in this._dtdTags[e]){var f=b.defer();return f.resolve(this._dtdTags[e][d]),f.promise}this._dtdTags[e][d]=[];var g=this,h={dtd_url:d};return e&&(h.text=e),a.get(c.jsonAPIUserUrl("xml/get-tags"),{params:h}).then(function(a){return g._dtdTags[e][d]=a.data,a.data})}}]).service("Utils",function(){this.getFormDataForSubmit=function(a){for(var b={url:a.data("action")},c=a.serializeArray(),d={},e=0,f=c.length;f>e;e++){var g=c[e];d[g.name]=g.value.replace(/\r/g,"")}return b.data=d,b},this.getBreadcrumbFiles=function(a,b){if(b="undefined"!=typeof b?b:"",""!==b&&0===a.indexOf(b)&&(a=a.slice(b.length),0===a.indexOf("/")&&(a=a.slice(1))),"undefined"==typeof a||""===a||null===a)return[{name:"root",path:b}];for(var c=[{name:"root",path:b}],d=a.split("/"),e="",f=0,g=d.length;g>f;f++){f>0&&(e+="/"),e+=d[f];var h={name:d[f]};g-1>f&&(h.path=e),c.push(h)}return c}}).service("FileUtils",["$http","$location","$modal","Session","MessageService","UrlFactory","Utils",function(a,b,c,d,e,f,g){var h=this;this.save=function(){var b;return d.submitForm?void d.submitForm():d.form.filename?(b=g.getFormDataForSubmit(d.form.$element),a.post(b.url,b.data).then(function(){d.form&&(d.form.status=null),e.set("success","Saved!")})):void this.saveasModal()},this.saveasModal=function(){var e=c.open({templateUrl:"navbar-saveas.html",controller:["$scope","$modalInstance",function(b,c){b.folder="",b.filename="",b.createFolder=function(){var c=f.jsonAPIUserUrl("create-folder");a.post(c,{path:d.currentPath,name:b.folder}).then(function(a){b.open(a.data.link),b.folder=""})},b.saveAs=function(a){if(a=a||b.filename){b.cancel();var c=[];d.currentPath&&c.push(d.currentPath),c.push(a);var e=c.join("/");d.form.setFilename(e),h.save().then(function(){d.setBreadcrumbFiles(e)})}},b.open=function(c){d.currentPath=c,b.breadcrumbFiles=g.getBreadcrumbFiles(c);var e=f.jsonAPIUserUrl("explore");a.get(e,{params:{path:c}}).then(function(a){b.files=a.data})},b.open(d.currentPath),b.cancel=function(){c.dismiss("cancel")}}]});e.result.then(function(a){var c=f.userUrl("xml/new");b.path(c).search(a)})}}]),angular.module("waxeApp").controller("SearchCtrl",["$scope","$http","$routeParams","$location","$anchorScroll","$modal","UrlFactory","Utils","XmlUtils","AccountProfile",function(a,b,c,d,e,f,g,h,i,j){a.UrlFactory=g,a.filetypes=[{text:"Select a filetype (optional)",value:""},{text:"xml",value:".xml"}],a.search={search:c.search,page:c.page,path:"",filetype:".xml"},a.totalItems=0,a.itemsPerPage=0,a.maxSize=10,a.results=[],a.doSearch=function(){d.search(a.search);var c=g.jsonAPIUserUrl("search");b.get(c,{params:a.search}).then(function(b){e(),a.results=b.data.results,a.totalItems=b.data.nb_items,a.itemsPerPage=b.data.items_per_page,a.$emit("pageLoaded")})},a.newSearch=function(){a.search.page=1,a.doSearch()},a.pageChanged=function(){a.doSearch()},angular.isDefined(a.search.search)&&a.doSearch(),a.currentPath=null,a.folderModal=function(){f.open({templateUrl:"search-folder.html",controller:["$scope","$modalInstance","parentScope",function(a,c,d){a.selectFolder=function(c){d.currentPath=c,a.breadcrumbFiles=h.getBreadcrumbFiles(c);var e=g.jsonAPIUserUrl("explore");b.get(e,{params:{path:c}}).then(function(b){a.files=b.data})},a.selectFolder(d.currentPath),a.cancel=function(){c.dismiss("cancel")},a.select=function(){d.search.path=d.currentPath,c.close()}}],resolve:{parentScope:function(){return a}}})},a.dtd_tag=null,a.tagModal=function(){var b=f.open({templateUrl:"tag-modal.html",controller:["$scope","$modalInstance","parentScope",function(a,b,c){a.dtd_url=c.dtd_url||j.dtd_urls[0],a.updateDtdTags=function(b){a.dtdTags=[],i.getDtdTags(a.dtd_url,!0).then(function(c){a.dtdTags=c,a.dtd_tag=b||a.dtdTags[0]})},a.updateDtdTags(c.dtd_tag),a.ok=function(){b.close({dtd_url:a.dtd_url,dtd_tag:a.dtd_tag}),c.dtd_url=a.dtd_url,c.dtd_tag=a.dtd_tag},a.cancel=function(){b.dismiss("cancel")}}],resolve:{parentScope:function(){return a}}});b.result.then(function(b){a.search.tag=b.dtd_tag})}}]),angular.module("waxeApp").controller("VersioningCtrl",["$scope","$http","$routeParams","$location","$modal","AccountProfile","UrlFactory","MessageService",function(a,b,c,d,e,f,g,h){!f.has_versioning;var i=function(){for(var b in a.versioning)if(a.versioning[b].length)return;a.emptyPage=!0};a.versioning={};var j=g.jsonAPIUserUrl("versioning/status");b.get(j,{params:c}).then(function(b){a.versioning=b.data,a.$emit("pageLoaded"),i()}),a.selectAll=function(a){angular.forEach(a,function(a){a.selected=!0})},a.deselectAll=function(a){angular.forEach(a,function(a){a.selected=!1})};var k=function(a){for(var b=0,c=a.length;c>b;b++)if(a[b].selected)return!0;return!1};a.doRevert=function(a){if(!k(a))return h.set("warning","Please select at least one file",void 0,1e3),!1;for(var c=[],d=[],e=0,f=a.length;f>e;e++){var j=a[e];j.selected===!0&&(c.push(j.relpath),d.push(j))}var l=g.jsonAPIUserUrl("versioning/revert");b.post(l,{paths:c}).then(function(){angular.forEach(d,function(b){var c=a.indexOf(b);a.splice(c,1)}),i()})},a.doCommit=function(a){if(!k(a))return h.set("warning","Please select at least one file",void 0,1e3),!1;var c=e.open({templateUrl:"commit.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close({message:a.message})},a.cancel=function(){b.dismiss("cancel")}}]});c.result.then(function(c){for(var d=[],e=[],f=0,j=a.length;j>f;f++){var k=a[f];k.selected===!0&&(d.push(k.relpath),e.push(k))}var l=g.jsonAPIUserUrl("versioning/commit");b.post(l,{paths:d,msg:c.message}).then(function(b){angular.forEach(e,function(b){var c=a.indexOf(b);a.splice(c,1)}),h.set("success",b.data),i()})})},a.doDiff=function(a){if(!k(a))return h.set("warning","Please select at least one file",void 0,1e3),!1;for(var b=[],c=0,e=a.length;e>c;c++){var f=a[c];f.selected===!0&&b.push(f.relpath)}var i=g.userUrl("versioning/diff");d.path(i).search({paths:b})}}]),angular.module("waxeApp").controller("VersioningDiffCtrl",["$scope","$http","$routeParams","$modal","$compile","$location","UrlFactory","Session","Utils","MessageService",function(a,b,c,d,e,f,g,h,i,j){var k=g.jsonAPIUserUrl("versioning/full-diff");b.get(k,{params:c}).then(function(b){a.diffs=b.data.diffs,a.diffOptions={attrs:{insert:{contenteditable:!0},equal:{contenteditable:!0}}},a.can_commit=b.data.can_commit,h.submitForm=a.submitForm,h.hasForm=!0,a.$emit("pageLoaded")}),a.submitForm=function(a){angular.element(".diff").each(function(){var a=angular.element(this),b="";a.contents().each(function(){var a=angular.element(this);a.is("del")||(b+=a.text())}),a.prev("textarea").val(b)});var c=angular.element(".diff-form"),e=i.getFormDataForSubmit(c),h=g.jsonAPIUserUrl("txt/updates");if(b.post(h,e.data).then(function(a){j.set("success",a.data)}),a===!0&&"undefined"!=typeof e.data){var k=[];for(var l in e.data)l.match(/:filename$/)&&k.push(e.data[l]);var m=d.open({templateUrl:"commit.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close({message:a.message})},a.cancel=function(){b.dismiss("cancel")}}]});m.result.then(function(a){var c=g.jsonAPIUserUrl("versioning/commit");j.set("commit","Commit in progress..."),b.post(c,{paths:k,msg:a.message}).then(function(a){j.set("success",a.data),f.url(g.userUrl("versioning/"))})})}}}]),angular.module("waxeApp").directive("diff",function(){return{template:"<div></div>",restrict:"E",link:function(a,b){var c=a.$watch(function(a){a.html&&(b.html(a.html),c())})}}}),angular.module("waxeApp").controller("VersioningUpdateCtrl",["$scope","$http","UrlFactory","MessageService",function(a,b,c,d){var e=c.jsonAPIUserUrl("versioning/update");b.get(e).then(function(b){a.files=b.data,a.length=a.files.length,a.$emit("pageLoaded")})}]),angular.module("waxeApp").controller("EditTxtCtrl",["$scope","$http","$sce","$routeParams","$route","$location","UrlFactory","Session","MessageService",function(a,b,c,d,e,f,g,h,i){a.editorOptions={lineWrapping:!0,lineNumbers:!0,mode:"xml"},h.hasForm=!0,h.submitForm=function(){var c=g.jsonAPIUserUrl("txt/update"),e={path:d.path,filecontent:a.txt},h=f.search().conflicted;angular.isDefined(h)&&(e.conflicted=h),b.post(c,e).then(function(){i.set("success","Saved!")})};var j=e.current.$$route.action,k=g.jsonAPIUserUrl("txt/"+j);b.get(k,{params:d}).then(function(b){a.txt=b.data,a.$emit("pageLoaded")})}]),angular.module("waxeApp").controller("VersioningUnifiedDiffCtrl",["$scope","$http","$routeParams","$modal","UrlFactory","MessageService",function(a,b,c,d,e,f){var g=e.jsonAPIUserUrl("versioning/diff");b.get(g,{params:c}).then(function(b){a.ok=angular.isDefined(b.data.diff)?!0:!1,a.diff=b.data.diff,a.can_commit=b.data.can_commit,a.$emit("pageLoaded")}),a.doCommit=function(){var g=d.open({templateUrl:"commit.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close({message:a.message})},a.cancel=function(){b.dismiss("cancel")}}]});g.result.then(function(d){var g=[c.path],h=e.jsonAPIUserUrl("versioning/commit");b.post(h,{paths:g,msg:d.message}).then(function(b){f.set("success",b.data),a.ok=!1})})},a.doRevert=function(){var d=e.jsonAPIUserUrl("versioning/revert"),g=[c.path];b.post(d,{paths:g}).then(function(b){f.set("success",b.data),a.ok=!1})}}]),angular.module("waxeApp").directive("contenteditable",["$sce",function(a){return{restrict:"A",require:"?ngModel",link:function(b,c,d,e){function f(){var a=c.html();d.stripBr&&"<br>"==a&&(a=""),e.$setViewValue(a)}e&&(e.$render=function(){c.html(a.getTrustedHtml(e.$viewValue||""))},c.on("blur keyup change",function(){b.$evalAsync(f)}))}}}]),angular.module("waxeApp").directive("ngConfirmClick",function(){return{priority:1,terminal:!0,restrict:"A",link:function(a,b,c){var d=c.ngConfirmClick||"Are you sure?",e=c.ngClick;b.bind("click",function(){window.confirm(d)&&a.$eval(e)})}}}),angular.module("waxeApp").directive("useraccount",["Session","UserProfile",function(a,b){return{template:'<div class="container alert-useraccount alert alert-warning" ng-if="Session.login != UserProfile.login">You are working on the account of <strong>{{Session.login}}</strong></div>',restrict:"E",replace:!0,link:function(c){c.Session=a,c.UserProfile=b}}}]);